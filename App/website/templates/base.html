<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      crossorigin="anonymous"
    />

    <title>{% block title %}Home{% endblock %}</title>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-dark"
      style="position: sticky; top: 0; z-index: 1000"
    >
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbar"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbar">
        <div class="navbar-nav" style="margin-left: 50px">
          {% if user.is_authenticated %}
          <a class="nav-item nav-link" id="home" href="/">Home</a>
          <a
            class="nav-item nav-link"
            id="logout"
            href="#"
            data-bs-toggle="modal"
            data-bs-target="#logoutModal"
            >Logout</a
          >
          {% else %}
          <a class="nav-item nav-link" id="login" href="/login">Login</a>
          <a class="nav-item nav-link" id="signUp" href="/sign-up">Sign Up</a>
          {% endif %}
        </div>
      </div>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %} {% if category ==
    'error' %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {{ message }}
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    {% elif category == 'success' %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      {{ message }}
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    {% elif category == 'success_center' %}
    <div
      class="alert alert-success alert-dismissible fade show text-center"
      role="alert"
    >
      {{ message }}
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    {% elif category == 'info' %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      {{ message }}
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    {% endif %} {% endfor %} {% endif %} {% endwith %}

    <div class="container">{% block content %} {% endblock %}</div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script
      type="text/javascript"
      src="{{ url_for('static', filename='index.js') }}"
    ></script>

    <script>
      MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
        },
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <div
      class="modal fade"
      id="logoutModal"
      tabindex="-1"
      aria-labelledby="logoutModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="logoutModalLabel">Logout Confirm</h5>
          </div>

          <div class="modal-body text-center">Do you want to logout?</div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <a href="/logout" class="btn btn-danger">Logout</a>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="violenceReportModal"
      tabindex="-1"
      aria-labelledby="violenceReportModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="violenceReportModalLabel">
              ðŸ’¥ Violence Detected!
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="violenceReportModalBody">
            <p>Loading report...</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="passwordCheckModal"
      tabindex="-1"
      aria-labelledby="passwordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="passwordModalLabel">
              ðŸ”’ Answer the question to continue
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            {% raw %}
            <p>Calculate this (x/y/z = d/m/y = Ntd's birthday):</p>
            <p class="text-center">
              $ \ln \left[ \lim_{a \to \infty} \left( 1 + \frac{1}{a} \right)^a
              \right] + (\sin^2 b + \cos^2 b) + z^{(z+1) \cdot
              \int_{\sin\left(\frac{16\pi}{x}\right) +
              1e-5}^{\cos\left(\frac{36\pi}{y}\right)} e^{z \ln(t)} \,dt} -
              \sum_{n=0}^{\infty} \frac{\cosh(c)\sqrt{1 - \tanh^2 (c)}}{2^n} $
            </p>
            {% endraw %}
            <form id="passwordCheckForm">
              <div class="mb-3">
                <label for="modalPasswordInput" class="form-label"
                  >Your answer: (Approximate integer)</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="modalPasswordInput"
                  required
                />
              </div>

              <input type="hidden" id="modalTargetUrl" value="" />

              <div
                id="modalErrorMessage"
                class="text-danger"
                style="display: none"
              ></div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="modalSubmitPassword"
            >
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const passwordModal = new bootstrap.Modal(
          document.getElementById("passwordCheckModal")
        );
        const passwordInput = document.getElementById("modalPasswordInput");
        const targetUrlInput = document.getElementById("modalTargetUrl");
        const errorMessage = document.getElementById("modalErrorMessage");
        const submitButton = document.getElementById("modalSubmitPassword");

        document.body.addEventListener("click", function (event) {
          const clickedLink = event.target.closest(".protected-link");

          if (clickedLink) {
            event.preventDefault();

            const destination = clickedLink.getAttribute("data-destination");

            targetUrlInput.value = destination;

            passwordInput.value = "";
            errorMessage.style.display = "none";

            passwordModal.show();
          }
        });

        submitButton.addEventListener("click", async function () {
          const password = passwordInput.value;
          const destination = targetUrlInput.value;

          try {
            const response = await fetch("/api/check-password", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ password: password }),
            });

            const data = await response.json();

            if (response.ok && data.success) {
              window.location.href = destination;
            } else {
              errorMessage.textContent = data.message || "An error occurred.";
              errorMessage.style.display = "block";
            }
          } catch (error) {
            console.error("Error checking password:", error);
            errorMessage.textContent = "Network error. Please try again.";
            errorMessage.style.display = "block";
          }
        });

        document
          .getElementById("passwordCheckForm")
          .addEventListener("submit", function (event) {
            event.preventDefault();
            submitButton.click();
          });
      });
    </script>
  </body>
</html>
